<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Times</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="padding: 20px;">

<div class="container">
    <a href="/">&larr; Voltar para a Página Inicial</a>

    <h1 class="mt-3">Gerenciar Times</h1>

    <a href="/add-time.html" class="btn btn-success mb-3">
        Adicionar Novo Time
    </a>

    <hr>

    <div id="area-de-alerta" class="alert alert-danger d-none" role="alert">
    </div>

    <h2>Times Cadastrados:</h2>
    <div id="lista-de-times">
    </div>
</div>

<script>
    // 3. Esta função busca os dados da nossa API
    async function buscarTimes() {
        console.log("Buscando times");

        const response = await fetch('/times');
        const times = await response.json();

        console.log("Dados recebidos:", times);
        mostrarTimesNaTela(times);
    }

    // 5. Esta função pega os dados (JSON) e transforma em HTML
    function mostrarTimesNaTela(times) {
        const container = document.getElementById('lista-de-times');
        container.innerHTML = '';

        const table = document.createElement('table');
        table.className = 'table table-striped';

        // 7. Cabeçalho da tabela
        table.innerHTML = `
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nome do Time</th>
                    <th>Estádio</th>
                    <th>Ações</th>
                </tr>
            </thead>
        `;

        // 8. Corpo da tabela
        const tbody = document.createElement('tbody');
        times.forEach(time => {
            const tr = document.createElement('tr');

            // 9. Linha da tabela (com todos os botões)
            tr.innerHTML = `
                <td>${time.id}</td>
                <td>${time.nome}</td>
                <td>${time.nomeEstadio}</td>
                <td>
                    <a href="/jogadores.html?timeId=${time.id}&timeNome=${time.nome}" class="btn btn-info btn-sm">Ver Jogadores</a>

                    <a href="/editar-time.html?id=${time.id}" class="btn btn-warning btn-sm">Editar</a>

                    <button class="btn btn-danger btn-sm" onclick="deletarTime(${time.id})">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
    }

    // Deletar um time (Com o banner de alerta)
    async function deletarTime(id) {

        const areaAlerta = document.getElementById('area-de-alerta');
        // Esconde o alerta (caso ele estivesse aparecendo de um erro anterior)
        areaAlerta.classList.add('d-none');

        if (confirm("Tem certeza que deseja excluir este time?")) {
            console.log(`Enviando pedido para deletar time ID: ${id}`);

            try {
                const response = await fetch(`/times/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // SUCESSO
                    console.log("Time excluído!");
                    buscarTimes();
                } else {
                    // ERRO
                    console.error("Erro ao excluir time.");
                    areaAlerta.textContent = "Não foi possível excluir o time. Verifique se ele possui jogadores cadastrados.";
                    areaAlerta.classList.remove('d-none'); // Mostra o alerta

                }
            } catch (error) {
                // ERRO (Falha de rede, etc)
                console.error("Erro na requisição:", error);
                areaAlerta.textContent = "Erro de comunicação com o servidor.";
                areaAlerta.classList.remove('d-none'); // Mostra o alerta
            }
        }
    }

    // 9. Roda a função de buscar assim que a página carregar
    window.onload = buscarTimes;

</script>
</body>
</html>